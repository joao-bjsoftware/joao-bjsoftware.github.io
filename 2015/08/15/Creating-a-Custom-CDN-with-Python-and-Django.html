<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Creating a Custom CDN with Python and Django</title>
    <meta name="description" content="" />
    <link href="//fonts.googleapis.com/css?family=Noto+Sans:300,400,700" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic" rel="stylesheet" type="text/css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="//joao-bjsoftware.github.io/themes/Saga/assets/css/style.css?v=1.0.0" rel="stylesheet" type="text/css">
    <link href="//joao-bjsoftware.github.io/themes/Saga/assets/css/animate.min.css?v=1.0.0" rel="stylesheet" type="text/css">
    <link href="//joao-bjsoftware.github.io/themes/Saga/favicon.ico" rel="shortcut icon">
    <link rel="canonical" href="https://joao-bjsoftware.github.io/2015/08/15/Creating-a-Custom-CDN-with-Python-and-Django.html" />
    
    <meta property="og:site_name" content="João Carvalho&#x27;s bit brushing" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Creating a Custom CDN with Python and Django" />
    <meta property="og:description" content="What is CDN and why should I serve static files this way? Hello everyone! I am João Carvalho. How are you? This is my first article in English language, so please, be patient with this Brazilian guy and feel free..." />
    <meta property="og:url" content="https://joao-bjsoftware.github.io/2015/08/15/Creating-a-Custom-CDN-with-Python-and-Django.html" />
    <meta property="article:published_time" content="2015-08-15T03:00:00.000Z" />
    <meta property="article:modified_time" content="2015-08-16T03:13:35.824Z" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Creating a Custom CDN with Python and Django" />
    <meta name="twitter:description" content="What is CDN and why should I serve static files this way? Hello everyone! I am João Carvalho. How are you? This is my first article in English language, so please, be patient with this Brazilian guy and feel free..." />
    <meta name="twitter:url" content="https://joao-bjsoftware.github.io/2015/08/15/Creating-a-Custom-CDN-with-Python-and-Django.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "João Carvalho&#x27;s bit brushing",
    "author": {
        "@type": "Person",
        "name": "João Dias de Carvalho Neto",
        "image": "https://avatars.githubusercontent.com/u/1715039?v=3",
        "url": "undefined/author/undefined",
        "sameAs": "http://jcarvalho.me"
    },
    "headline": "Creating a Custom CDN with Python and Django",
    "url": "https://joao-bjsoftware.github.io/2015/08/15/Creating-a-Custom-CDN-with-Python-and-Django.html",
    "datePublished": "2015-08-15T03:00:00.000Z",
    "dateModified": "2015-08-16T03:13:35.824Z",
    "description": "What is CDN and why should I serve static files this way? Hello everyone! I am João Carvalho. How are you? This is my first article in English language, so please, be patient with this Brazilian guy and feel free..."
}
    </script>

    <meta name="generator" content="Ghost ?" />
    <link rel="alternate" type="application/rss+xml" title="João Carvalho&#x27;s bit brushing" href="https://joao-bjsoftware.github.io/rss" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
</head>
<body class="post-template">
    <header id="header" class="animated fadeIn">
    <div class="header-background">
    <section class="blog-content">
        <a id="site-url" class="blog-title" href="https://joao-bjsoftware.github.io">João Carvalho&#x27;s bit brushing</a>
        <span class="blog-description">Bits are made winding through my head</span>
        <nav class="links fadeIn animated">
            <ul>
                <!-- <li class="rss"><a title="RSS Feed" href="/rss/"><i class="fa fa-fw fa-rss-square"></i></a></li> -->
        
            </ul>
        </nav>
    </section>
    <section class="header-content">
        <h1 class="post-title animated fadeInUp">Creating a Custom CDN with Python and Django</h1>
        <span class="post-data"><span class="date animated fadeInUp"><i class="fa fa-clock-o"></i> <time class="timesince date" data-timesince="1439607600" datetime="2015-08-15T00:00" title="15 August 2015">2015-08-15 00:00:00<ago class="ago"></time></span>
            
            <span class="author animated fadeInUp"><i class="fa fa-user"></i> <a href="">João Dias de Carvalho Neto</a></span></span>
    </section>
    </div>
</header>
<main id="main" class="content">
    <article itemtype="http://schema.org/BlogPosting" class="animated fadeIn content post post">
        <section class="post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="/images/cdn.png" alt="Creating a Custom CDN With Python and Django">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_cdn_and_why_should_i_serve_static_files_this_way">What is CDN and why should I serve static files this way?</h3>
<div class="paragraph">
<p>Hello everyone!</p>
</div>
<div class="paragraph">
<p>I am João Carvalho. How are you? This is my first article in English language, so please, be patient with this Brazilian guy and feel free to report any misunderstood in comments.</p>
</div>
<div class="paragraph">
<p>After a long time without post anything (I was really very busy with happy coding) I am here to talk about serving files through a CDN (Content Delivery Network) structure with Django Framework.</p>
</div>
<div class="paragraph">
<p>A CDN is a structured network to serve files in various storage servers. The main advantages to use it is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To control the user&#8217;s storage quota;</p>
</li>
<li>
<p>To control the user&#8217;s bandwidth quota;</p>
</li>
<li>
<p>To avoid the users access files directly;</p>
</li>
<li>
<p>Grant and revoke access when some signal is triggered;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the first, you must think if you really need to use it. You should consider a to use a CDN to server files when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Your files only can be downloaded with a general link to it</p>
</li>
<li>
<p>Your files cannot be accessed by it&#8217;s direct file URL</p>
</li>
<li>
<p>You need to log file&#8217;s size and download count for bandwidth consumption and disk space usage</p>
</li>
<li>
<p>You must restrict those file&#8217;s access with some particular business rule, for example when the user access expires.</p>
</li>
<li>
<p>You have a large number of files and need to allocate on optimized storage servers instead your application server</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_cool_i_need_it_let_s_do_this">Cool, I need it! Let&#8217;s do this!</h3>
<div class="paragraph">
<p>For learning purposes, let&#8217;s imagine the following fictional scenario. Please, feel free to extends at your needs.</p>
</div>
<div class="paragraph">
<p>1 - We need to log user file upload statistics (For disk quota);</p>
</div>
<div class="paragraph">
<p>2 - We need to log user file download statistics (For bandwidth quota);</p>
</div>
<div class="paragraph">
<p>So Let&#8217;s do this:</p>
</div>
<div class="paragraph">
<p>First of all you must add a setting in settings.py file that will be our MEDIA_PRIVATE_ROOT. All private files will be placed here.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import os
BASE_DIR = os.path.dirname(os.path.dirname(__file__))
MEDIA_PRIVATE_ROOT = os.path.join(BASE_DIR, 'media_private')</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will also need a software requirement:</p>
</div>
<div class="paragraph">
<p>Many people knows that Django Server is not the usual way to serve media and static files. Many Web Servers handle better with in this functionality, so, we will need django-filetransfers package that forces your current Web Server to handle downloads instead your Django application</p>
</div>
<div class="paragraph">
<p>Basically, using django-filetransfers with the x-sendfile Web Server module a HTTP header will be set to ensure that NGINX or Apache will handle download instead Django Server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">pip install django-filetransfers</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we must create two Model Classes to handle with disk usage and bandwidth quota.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python"># - coding: utf-8 -
from django.db import models

class DiskUsage(models.Model):
    u"""

    This class will manage disk usage to
    check storage quota

    """
    file_path = models.FilePathField(max_length=255,
                                     db_column='file_path',
                                     null=False, blank=False,
                                     unique=True)

    size = models.DecimalField(db_column='size',
                               null=False, blank=False,
                               max_digits=18,
                               decimal_places=2)

    class Meta:
        db_table = 'cdn_disk'


class BandwidthUsage(models.Model):
    u"""

    This class will manage file downloads to
    check bandwidth quota

    """

    log = models.ForeignKey(DiskUsage, null=False, blank=False,
                            db_column='log_id')

    date = models.DateTimeField(db_column='date', auto_now=True,
blank=False,
                                null=False)

    size = models.DecimalField(db_column='size',
                               null=False, blank=False,
                               max_digits=18,
                               decimal_places=2,
                               default=0)

    class Meta:
        db_table = 'cdn_down'</code></pre>
</div>
</div>
<div class="paragraph">
<p>After do it, we&#8217;ll create the engine of CDN process. Django Framework uses an intermediary class to work with file System. Let&#8217;s extends <strong>FileSystemStorage</strong> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class PrivateStorage(FileSystemStorage):

    def __init__(self, location=None):
        if not location:
            raise ImproperlyConfigured(u"File System location not
defined")
        FileSystemStorage.__init__(self, location=location)
        #Here you can adjust file permissions for you new files
        self.file_permissions_mode = 0644

    def get_available_name(self, name):
        u"""

        This method will check if a file exists in OS
        then delete it for "update"

        You can do another behavior here if you
        don't like this one.

        Create a new name then return is a
        good example for do it

        """
        if self.exists(name):
            self.delete(name)
        return name

    def open(self, name, mode='r'):
        u"""

        This method is called every time that someone
        requests to download or use a file

        """
        try:
            file = DiskUsage.objects.get(file_path=self.path(name))
        except:
            #If a file disk usage does not
            #exists there's no file to download
            raise Http404()
        band = BandwidthUsage()
        band.log_id = file.id
        #Date is for query bandwidth per month for example
        band.date = datetime.now()
        band.size = self.size(name)
        band.save()
        return FileSystemStorage.open(self, name, mode)

    def _save(self, name, content):
        u"""

        Triggered when someone saves a file to your disk.
        Our intent here is compute the size for log disk usage

        """
        path = self.path(name)
        #Our field limitation
        if len(path) &gt; 255:
            raise Exception(u"File path is too big")

        #Try to catch an existing file, if something goes
        #wrong, a new one instance is created
        #REMEMBER: According our models file_path is UNIQUE
        try:
            file = DiskUsage.objects.get(file_path=path)
        except:
            file = DiskUsage()

        file.file_path = self.path(name)
        save_name = FileSystemStorage._save(self, name, content)
        file.size = self.size(name)

        file.save()
        return save_name

    def exists(self, name):
        u"""

        I extend this method only to demonstrate you
        that you can add custom behaviors here

        """
        fExist = os.path.exists(self.path(name))
        return fExist

    def delete(self, name):
        u"""

        I extend this method only to demonstrate you
        that you can add custom behaviors here

        """
        FileSystemStorage.delete(self, name)</code></pre>
</div>
</div>
</div>
        </section>

    
        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'joaocarvalho'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>
    
    </article>

</main>
    <footer class="animated fadeIn" id="footer">
        <section class="colophon">
          <section class="copyright">Copyright &copy; <span itemprop="copyrightHolder">João Carvalho&#x27;s bit brushing</span>. <span rel="license">All Rights Reserved</span>.</section>
          <section class="poweredby">Published with <a class="icon-ghost" href="http://hubpress.io">HubPress</a></section>
        </section>
        <section class="bottom">
          <section class="attribution">
            <a href="http://github.com/Reedyn/Saga">Built with <i class="fa fa-heart"></i> and Free and Open-Source Software</a>.
          </section>
        </section>
    </footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();      
      </script>
    <script src="//joao-bjsoftware.github.io/themes/Saga/assets/js/scripts.js?v=1.0.0"></script>
    
</body>
</html>
