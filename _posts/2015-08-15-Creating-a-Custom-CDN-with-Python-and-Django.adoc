= Creating a Custom CDN with Python and Django

image::cdn.png[Creating a Custom CDN With Python and Django]

### What is CDN and why should I serve static files this way?

Hello everyone!

I am Jo√£o Carvalho. How are you? This is my first article in English language, so please, be patient with this Brazilian guy and feel free to report any misunderstood in comments.

After a long time without post anything (I was really very busy with happy coding) I am here to talk about serving files through a CDN (Content Delivery Network) structure with Django Framework.

A CDN is a structured network to serve files in various storage servers. The main advantages to use it is:

- To control the user's storage quota;

- To control the user's bandwidth quota;

- To avoid the users access files directly;

- Grant and revoke access when some signal is triggered;


In the first, you must think if you really need to use it. You should consider a to use a CDN to server files when:

- Your files only can be downloaded with a general link to it

- Your files cannot be accessed by it's direct file URL

- You need to log file's size and download count for bandwidth consumption and disk space usage

- You must restrict those file's access with some particular business rule, for example when the user access expires.

- You have a large number of files and need to allocate on optimized storage servers instead your application server


### Cool, I need it! Let's do this!

For learning purposes, let's imagine the following fictional scenario. Please, feel free to extends at your needs.

1 - We need to log user file upload statistics (For disk quota);

2 - We need to log user file download statistics (For bandwidth quota);

So Let's do this:

First of all you must add a setting in settings.py file that will be our MEDIA_PRIVATE_ROOT. All private files will be placed here.

```python
import os
BASE_DIR = os.path.dirname(os.path.dirname(__file__))
MEDIA_PRIVATE_ROOT = os.path.join(BASE_DIR, 'media_private')

```
We will also need a software requirement:

Many people knows that Django Server is not the usual way to serve media and static files. Many Web Servers handle better with in this functionality, so, we will need django-filetransfers package that forces your current Web Server to handle downloads instead your Django application

Basically, using django-filetransfers with the x-sendfile Web Server module a HTTP header will be set to ensure that NGINX or Apache will handle download instead Django Server.


```bash

pip install django-filetransfers

```
Now, we must create two Model Classes to handle with disk usage and bandwidth quota.

```python
# - coding: utf-8 -
from django.db import models

class DiskUsage(models.Model):
    u"""
    
    This class will manage disk usage to 
    check storage quota 

    """
    file_path = models.FilePathField(max_length=255,
                                     db_column='file_path',
                                     null=False, blank=False,
                                     unique=True)

    size = models.DecimalField(db_column='size',
                               null=False, blank=False,
                               max_digits=18,
                               decimal_places=2)

    class Meta:
        db_table = 'cdn_disk'


class BandwidthUsage(models.Model):
    u"""

    This class will manage file downloads to 
    check bandwidth quota

    """

    log = models.ForeignKey(DiskUsage, null=False, blank=False,
                            db_column='log_id')

    date = models.DateTimeField(db_column='date', auto_now=True, 
blank=False,
                                null=False)

    size = models.DecimalField(db_column='size',
                               null=False, blank=False,
                               max_digits=18,
                               decimal_places=2,
                               default=0)

    class Meta:
        db_table = 'cdn_down'

```